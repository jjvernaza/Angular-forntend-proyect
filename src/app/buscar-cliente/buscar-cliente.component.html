<div class="p-6">
  <h1 class="text-4xl font-bold mb-4">Buscar Clientes</h1>

  <!-- ✅ Verificar permiso para ver clientes -->
  <div *ngIf="!tienePermisoLeer" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <p class="font-bold">Acceso Denegado</p>
    <p>No tienes permisos para ver clientes.</p>
  </div>

  <!-- Filtros de búsqueda en una sola línea -->  
  <div *ngIf="tienePermisoLeer" class="flex items-center mb-4 space-x-2">
    <input type="text" 
           placeholder="Buscar por ID" 
           [(ngModel)]="filtro.id" 
           class="search-input"
           [disabled]="!tienePermisoLeer">
    <input type="text" 
           placeholder="Buscar por nombre" 
           [(ngModel)]="filtro.nombre" 
           class="search-input"
           [disabled]="!tienePermisoLeer">
    <input type="text" 
           placeholder="Buscar por apellido" 
           [(ngModel)]="filtro.apellido" 
           class="search-input"
           [disabled]="!tienePermisoLeer">
    <input type="text" 
           placeholder="Buscar por cédula" 
           [(ngModel)]="filtro.cedula" 
           class="search-input"
           [disabled]="!tienePermisoLeer">
    <input type="text" 
           placeholder="Buscar por teléfono" 
           [(ngModel)]="filtro.telefono" 
           class="search-input"
           [disabled]="!tienePermisoLeer">
    <input type="text" 
           placeholder="Buscar por ubicación" 
           [(ngModel)]="filtro.ubicacion" 
           class="search-input"
           [disabled]="!tienePermisoLeer">
    
    <button class="btn-search" 
            (click)="buscarClientes()"
            [disabled]="!tienePermisoLeer">
      <i class="fas fa-search"></i> Buscar
    </button>
    <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" 
            (click)="limpiarFiltros()"
            [disabled]="!tienePermisoLeer">
      <i class="fas fa-eraser"></i> Limpiar Filtros
    </button>
  </div>

  <!-- Contador de resultados -->
  <div *ngIf="tienePermisoLeer && clientes.length > 0" class="mb-3 text-gray-600">
    <strong>{{ clientes.length }}</strong> cliente(s) encontrado(s)
  </div>

  <!-- Tabla de clientes -->
  <div *ngIf="tienePermisoLeer" class="table-container">
    <table class="min-w-full bg-white border border-gray-200">
      <thead>
        <tr>
          <th class="border border-gray-300 px-4 py-2">ID</th>
          <th class="border border-gray-300 px-4 py-2">Nombre Completo</th>
          <th class="border border-gray-300 px-4 py-2">Plan MB</th>
          <th class="border border-gray-300 px-4 py-2">Fecha Instalación</th>
          <th class="border border-gray-300 px-4 py-2">Tipo Servicio</th>
          <th class="border border-gray-300 px-4 py-2">Tarifa</th>
          <th class="border border-gray-300 px-4 py-2">Sector</th>
          <th class="border border-gray-300 px-4 py-2">Dirección IP</th>
          <th class="border border-gray-300 px-4 py-2">Teléfono</th>
          <th class="border border-gray-300 px-4 py-2">Ubicación</th>
          <th class="border border-gray-300 px-4 py-2">Cédula</th>
          <th class="border border-gray-300 px-4 py-2">Estado</th>
          <th class="border border-gray-300 px-4 py-2">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cliente of clientes">
          <td class="border border-gray-300 px-4 py-2">{{ cliente.ID }}</td>
          <td class="border border-gray-300 px-4 py-2">
            {{ cliente.NombreCliente }} {{ cliente.ApellidoCliente }}
          </td>
          <td class="border border-gray-300 px-4 py-2">
            <span *ngIf="cliente.plan && cliente.plan.nombre; else noPlan">
              {{ cliente.plan.nombre }}
              <small class="text-gray-500 block">{{ cliente.plan.velocidad }}</small>
            </span>
            <ng-template #noPlan>
              <span class="text-red-400">Sin plan</span>
            </ng-template>
          </td>
          <td class="border border-gray-300 px-4 py-2">{{ cliente.FechaInstalacion | date:'dd/MM/yyyy' }}</td>
          <td class="border border-gray-300 px-4 py-2">
            <span *ngIf="cliente.tipoServicio && cliente.tipoServicio.Tipo; else noTipoServicio">
              {{ cliente.tipoServicio.Tipo }}
            </span>
            <ng-template #noTipoServicio>
              <span class="text-red-400">Sin tipo</span>
            </ng-template>
          </td>
          <td class="border border-gray-300 px-4 py-2">
            <span *ngIf="cliente.tarifa && cliente.tarifa.valor; else noTarifa" class="font-semibold text-green-600">
              ${{ cliente.tarifa.valor | number:'1.0-0' }}
            </span>
            <ng-template #noTarifa>
              <span class="text-red-400">Sin tarifa</span>
            </ng-template>
          </td>
          <td class="border border-gray-300 px-4 py-2">
            <span *ngIf="cliente.sector; else noSector">
              {{ cliente.sector.nombre }}
            </span>
            <ng-template #noSector>
              <span class="text-gray-400">Sin sector</span>
            </ng-template>
          </td>
          <td class="border border-gray-300 px-4 py-2">{{ cliente.IPAddress }}</td>
          <td class="border border-gray-300 px-4 py-2">{{ cliente.Telefono }}</td>
          <td class="border border-gray-300 px-4 py-2">{{ cliente.Ubicacion }}</td>
          <td class="border border-gray-300 px-4 py-2">{{ cliente.Cedula }}</td>
          <td class="border border-gray-300 px-4 py-2">
            <span *ngIf="cliente.estado && cliente.estado.Estado; else noEstado" 
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                  [style.background-color]="cliente.estado.Color || getEstadoColorByName(cliente.estado.Estado)"
                  [style.color]="getTextColorForBg(cliente.estado.Color || getEstadoColorByName(cliente.estado.Estado))">
              {{ cliente.estado.Estado }}
            </span>
            <ng-template #noEstado>
              <span class="text-gray-400">Sin estado</span>
            </ng-template>
          </td>
          <td class="border border-gray-300 px-4 py-2 text-center">
            <!-- ✅ Botón Editar - Solo visible si tiene permiso -->
            <button *ngIf="tienePermisoActualizar"
                    (click)="abrirModalEditar(cliente)" 
                    class="text-blue-500 mr-2 hover:text-blue-700"
                    title="Editar cliente">
              <i class="fas fa-pencil-alt"></i>
            </button>
            
            <!-- ⚠️ Botón Editar deshabilitado si NO tiene permiso -->
            <button *ngIf="!tienePermisoActualizar"
                    (click)="mostrarMensajePermisos('editar')"
                    class="text-gray-400 mr-2 cursor-not-allowed opacity-50"
                    title="No tienes permiso para editar">
              <i class="fas fa-pencil-alt"></i>
            </button>
            
            <!-- ✅ Botón Eliminar - Solo visible si tiene permiso -->
            <button *ngIf="tienePermisoEliminar"
                    (click)="abrirModalEliminar(cliente.ID)" 
                    class="text-red-500 hover:text-red-700"
                    title="Eliminar cliente">
              <i class="fas fa-trash-alt"></i>
            </button>
            
            <!-- ⚠️ Botón Eliminar deshabilitado si NO tiene permiso -->
            <button *ngIf="!tienePermisoEliminar"
                    (click)="mostrarMensajePermisos('eliminar')"
                    class="text-gray-400 cursor-not-allowed opacity-50"
                    title="No tienes permiso para eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mensaje cuando no hay resultados -->
  <div *ngIf="tienePermisoLeer && clientes.length === 0" class="text-center py-8 text-gray-500">
    <i class="fas fa-search text-4xl mb-3"></i>
    <p class="text-lg">No se encontraron clientes con los criterios de búsqueda.</p>
  </div>
</div>

<!-- Modal de edición -->
<div *ngIf="modalEditar && tienePermisoActualizar" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded shadow-lg w-2/3 max-h-screen overflow-y-auto">
    <h2 class="text-2xl font-bold mb-4">Editar Cliente</h2>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block font-semibold mb-1">Nombre Cliente</label>
        <input type="text" [(ngModel)]="clienteEdit.NombreCliente" class="border p-2 w-full mb-3">
      </div>
      <div>
        <label class="block font-semibold mb-1">Apellido Cliente</label>
        <input type="text" [(ngModel)]="clienteEdit.ApellidoCliente" class="border p-2 w-full mb-3">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block font-semibold mb-1">Plan MB</label>
        <select [(ngModel)]="clienteEdit.plan_mb_id" class="border p-2 w-full mb-3">
          <option value="">Seleccionar Plan</option>
          <option *ngFor="let plan of planes" [value]="plan.id">
            {{ plan.nombre }} - {{ plan.velocidad }}
          </option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Fecha Instalación</label>
        <input type="date" [(ngModel)]="clienteEdit.FechaInstalacion" class="border p-2 w-full mb-3">
      </div>
    </div>

    <div class="grid grid-cols-3 gap-3">
      <div>
        <label class="block font-semibold mb-1">Tipo de Servicio</label>
        <select [(ngModel)]="clienteEdit.TipoServicioID" class="border p-2 w-full mb-3">
          <option value="">Seleccionar Tipo</option>
          <option *ngFor="let tipo of tiposServicio" [value]="tipo.ID">
            {{ tipo.Tipo }}
          </option>
        </select>        
      </div>
      <div>
        <label class="block font-semibold mb-1">Tarifa</label>
        <select [(ngModel)]="clienteEdit.tarifa_id" class="border p-2 w-full mb-3">
          <option value="">Seleccionar Tarifa</option>
          <option *ngFor="let tarifa of tarifas" [value]="tarifa.id">
            ${{ tarifa.valor }}
          </option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Sector</label>
        <select [(ngModel)]="clienteEdit.sector_id" class="border p-2 w-full mb-3">
          <option value="">Seleccionar Sector</option>
          <option *ngFor="let sector of sectores" [value]="sector.id">
            {{ sector.nombre }}
          </option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block font-semibold mb-1">Estado</label>
        <select [(ngModel)]="clienteEdit.EstadoID" class="border p-2 w-full mb-3">
          <option value="">Seleccionar Estado</option>
          <option *ngFor="let estado of estados" [value]="estado.ID">
            {{ estado.Estado }}
          </option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Dirección IP</label>
        <input type="text" [(ngModel)]="clienteEdit.IPAddress" class="border p-2 w-full mb-3">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block font-semibold mb-1">Teléfono</label>
        <input type="text" [(ngModel)]="clienteEdit.Telefono" class="border p-2 w-full mb-3">
      </div>
      <div>
        <label class="block font-semibold mb-1">Cédula</label>
        <input type="text" [(ngModel)]="clienteEdit.Cedula" class="border p-2 w-full mb-3">
      </div>
    </div>

    <label class="block font-semibold mb-1">Ubicación</label>
    <input type="text" [(ngModel)]="clienteEdit.Ubicacion" class="border p-2 w-full mb-3">

    <div class="flex justify-end mt-4 space-x-2">
      <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" (click)="guardarEdicion()">Guardar</button>
      <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" (click)="modalEditar = false">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de eliminación -->
<div *ngIf="modalEliminar && tienePermisoEliminar" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white p-6 rounded shadow-lg w-1/3">
    <h2 class="text-2xl font-bold mb-4">¿Eliminar este cliente?</h2>
    <p class="text-gray-600 mb-4">Esta acción no se puede deshacer.</p>
    <div class="flex justify-end space-x-2">
      <button class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" (click)="eliminarCliente()">Eliminar</button>
      <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" (click)="modalEliminar = false">Cancelar</button>
    </div>
  </div>
</div>